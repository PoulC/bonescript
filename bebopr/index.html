<html>
<head>
<title>Beaglebone + BeBoPr cape</title>
<style type="text/css" media="all">@import "/style.css";</style>
<link type="text/css" href="css/smoothness/jquery-ui-1.8.20.custom.css" rel="stylesheet" />
<script src="js/jquery-1.7.2.min.js"></script>
<script src="js/jquery-ui-1.8.20.custom.min.js"></script>
<script src="js/jquery.flot.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
	<style type="text/css">
		body{ font: 62.5% "Trebuchet MS", sans-serif; margin: 50px;}
        div.graphstuff{width: 80%px;}        
	</style>
</head>
<body>
<h1>Beaglebone + BeBoPr cape</h1>

<div id="radio">
    <input type="radio" id="ioenabled" name="radio" /><label for="ioenabled">Enabled</label>
	<input type="radio" id="iodisabled" name="radio" checked="checked" /><label for="iodisabled">Disabled</label>
</div><br/><br/>

<div class="graphstuff">
    <div id="ainplot" style="width:100%;height:50%;"></div>
    <center><div id="graphenable">
        <input type="checkbox" id="AIN2" checked="true"/><label for="AIN2">AIN2</label>
    	<input type="checkbox" id="AIN4" checked="true"/><label for="AIN4">AIN4</label>
    	<input type="checkbox" id="AIN6" checked="true"/><label for="AIN6">AIN6</label>
    </div></center>
    <div>
        <span id="pwm0name">PWM0</span> duty cycle %
        <div id="pwm0Slider"></div>
    </div><br>
    <div>
        <span id="pwm1name">PWM1</span> duty cycle %
        <div id="pwm1Slider"></div>
    </div><br>
    <div>
        <span id="pwm2name">PWM2</span> duty cycle %
        <div id="pwm2Slider"></div>
    </div><br>
</div>

<h2>Status:</h2>
<p><span id="status">Not yet connected</span></p>


<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
var socket = new io.connect();
socket.on('connect', function() {
    document.getElementById("status").innerHTML="Connected";
});

var tempUpdatems = 500;
var pwmUpdatems = 500;
var updatePlotms = 1000;

graphRangesecs = 400;

// data size, should be larger than update frequency * graph range seconds
// 1000 * graphRangesecs / tempUpdatems
var graphDataSize = (1000 * graphRangesecs / tempUpdatems) * 1.2;

ain2Name = "Heatbed";
ain4Name = "Ambient";
ain6Name = "Extruder";

pwm0Name = "Fan";
pwm1Name = "Extruder";
pwm2Name = "Heatbed";

flotData = new Array(3);
flotData[0] = new Array(graphDataSize);
flotData[1] = new Array(graphDataSize);
flotData[2] = new Array(graphDataSize);

// Use a running average to smooth out the AIN plots
smoothLength = 12;
smooth = new Array(3);
smooth[0] = new Array(smoothLength);
smooth[1] = new Array(smoothLength);
smooth[2] = new Array(smoothLength);

pwmData = new Array(3);
pwmData[0] = new Array(graphDataSize);
pwmData[1] = new Array(graphDataSize);
pwmData[2] = new Array(graphDataSize);

graphEnabled = [1,1,1];

average = function(a) {
	var r = {
		mean: 0,
		variance: 0,
		deviation: 0
	},
		t = a.length;
	for (var m, s = 0, l = t; l--; s += a[l]);
	for (m = r.mean = s / t, l = t, s = 0; l--; s += Math.pow(a[l] - m, 2));
	return r.deviation = Math.sqrt(r.variance = s / t), r;
}

function updatePlot() {
    
    var datasets = [
        {
    		label: ain2Name + " temperature",
    		data: flotData[0],
            color: "#333",
    	},
        {
    		label: pwm2Name + " duty cycle",
            line: { show: true, fill: 0.05, lineWidth: 1 },
    		data: pwmData[2],
            color: "#888",
    	},        
    	{
    		label: ain4Name + " temperature",
    		data: flotData[1],
            color: "#0ff",
    	},
        {
    		label: pwm0Name + " duty cycle",
            lines: { show: true, fill: 0.05, lineWidth: 1 },
    		data: pwmData[0],
            color: "0aa",
    	},        
    	{
    		label: ain6Name + " temperature",
    		data: flotData[2],
            color: "#ff0",
    	},
        {
    		label: pwm1Name + " duty cycle",
            lines: { show: true, fill: 0.05, lineWidth: 1 },
    		data: pwmData[1],
            color: "#aa0",
    	}        
    ];
    var flotPlot = [];
    for (i = 0; i < 3; i = i + 1) {
        if (graphEnabled[i] == 1) {
            flotPlot.push(datasets[i*2]);
            flotPlot.push(datasets[i*2 + 1])
        }
    }
    
    var now = (new Date()).getTime();
    
    $.plot($("#ainplot"), flotPlot, {
    	xaxis: {
    		mode: "time",
    		minTickSize: [1, "minute"],
    		min: now - graphRangesecs * 1000,
    		max: now,
    	},
    	yaxis: {
    		min: 0,
    		max: 250,
    	}
    });  
    
    setTimeout(function() { updatePlot(); }, updatePlotms);
}

socket.on('ain', function(data) {
    if(!data[2])
        data[2] = 0;

    if(!data[4])
        data[4] = 0;

    if(!data[6])
        data[6] = 0;

    if (data[2] > 230) {
    	pwm0value = $('#pwm0Slider').slider("option", "value");
    	socket.emit('pwmdutypercent', [0, pwm0value * 0.50]);
    }
    
    if (data[4] > 230) {
    	pwm0value = $('#pwm1Slider').slider("option", "value");
    	socket.emit('pwmdutypercent', [1, pwm1value * 0.50]);
    }
    
    if (data[6] > 230) {
    	pwm0value = $('#pwm2Slider').slider("option", "value");
    	socket.emit('pwmdutypercent', [1, pwm1value * 0.50]);
    }


    //document.getElementById("ain2temp").innerHTML="AIN2: " + data[2] + "&#8451";
    //document.getElementById("ain4temp").innerHTML="AIN4: " + data[4] + "&#8451";
    //document.getElementById("ain6temp").innerHTML="AIN6: " +data[6] + "&#8451";
        
    for (j = 0; j < 3; j++) {
        var myData = parseFloat(data[(j + 1) * 2]);
        if (myData > 0) {
            for (var s = 0; s < smoothLength - 1; s++) {
             	smooth[j][s] = smooth[j][s + 1];
            }
            smooth[j][s] = myData;
         	for (var i = 0; i < graphDataSize - 1; i++) {
         		flotData[j][i] = flotData[j][i + 1];
            }
            flotData[j][i] = [data[0], average(smooth[j]).mean];
        }
    }
        
    setTimeout(function() {socket.emit('getTemp', 1);}, tempUpdatems);
});

socket.on('PWM', function(data) {
    pwm0dutypercent = data[0];
    pwm1dutypercent = data[1];
    pwm2dutypercent  = data[2];
    
    $('#pwm0Slider').slider( "value", pwm0dutypercent );
    $('#pwm1Slider').slider( "value", pwm1dutypercent );
    $('#pwm2Slider').slider( "value", pwm2dutypercent );
    
    for (j = 0; j < 3; j = j + 1) {
        if (data[j] < 101) {
             for (var i = 0; i < graphDataSize - 1; i++) {
         		pwmData[j][i] = pwmData[j][i + 1];
            }
            pwmData[j][i] = [data[3], data[j]];
        }
    }    

    setTimeout(function() {socket.emit('getPWM', 1);}, pwmUpdatems);
});

socket.on('ioenableState', function(data) {
    if(data > 0)
        $('#ioenabled').attr('checked','checked').button("refresh");
});

socket.emit('getTemp', 1);
socket.emit('getPWM', 1);

$(function() {

    updatePlot();

    $("#radio").buttonset();
    
    socket.emit('ioenable', "read");
    $("#radio :radio").click(function() {
    	//alert($(this).attr("id"));
    	if ($(this).attr("id") == "ioenabled") {
    		socket.emit('ioenable', "enable");
    		$('#pwm0Slider').slider("enable");
    		$('#pwm1Slider').slider("enable");
    		$('#pwm2Slider').slider("enable");
    	}
    	else {
    		socket.emit('ioenable', "disable");
    		$('#pwm0Slider').slider("disable");
    		$('#pwm1Slider').slider("disable");
    		$('#pwm2Slider').slider("disable");
    	}
    });       

    $("#graphenable").buttonset();

    //set proper names for AIN and PWM functions
    $("#AIN2").button('option', 'label', ain2Name);
    $("#AIN4").button('option', 'label', ain4Name);
    $("#AIN6").button('option', 'label', ain6Name);
    
    $("#pwm0name").text(pwm0Name);
    $("#pwm1name").text(pwm1Name);
    $("#pwm2name").text(pwm2Name);
    
    $("#graphenable :checkbox").click(function(){
        //alert($(this).attr("id") + " " + $(this).is(":checked"));
        if($(this).attr("id") == "AIN2") {
            if ($(this).is(":checked"))
                graphEnabled[0] = 1;
            else
                graphEnabled[0] = 0;
        }
        if($(this).attr("id") == "AIN4") {
            if ($(this).is(":checked"))
                graphEnabled[1] = 1;
            else
                graphEnabled[1] = 0;
        }
        if($(this).attr("id") == "AIN6") {
            if ($(this).is(":checked"))
                graphEnabled[2] = 1;
            else
                graphEnabled[2] = 0;
        }
        updatePlot();
    });

    // only report changes if they weren't done programatically via getPWM
    $('#pwm0Slider').slider({ min: 0, max: 100, step: 1, animate: true,
        change: function(event, ui) {  
            if(event.originalEvent!=undefined) 
                socket.emit('pwmdutypercent', [ 0, ui.value ]);
        }
    });
    $('#pwm1Slider').slider({ min: 0, max: 100, step: 1, animate: true,
        change: function(event, ui) {
            if(event.originalEvent!=undefined) 
                socket.emit('pwmdutypercent', [ 1, ui.value ]); 
        }
    });
    $('#pwm2Slider').slider({ min: 0, max: 100, step: 1, animate: true,
        change: function(event, ui) { 
            if(event.originalEvent!=undefined) 
                socket.emit('pwmdutypercent', [ 2, ui.value ]);
            }
    });
});

</script>

</body>
</html>
