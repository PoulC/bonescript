<html>
<head>
<title>Beaglebone + BeBoPr cape</title>
<style type="text/css" media="all">@import "/style.css";</style>
<link type="text/css" href="css/smoothness/jquery-ui-1.8.20.custom.css" rel="stylesheet" />
<script src="js/jquery-1.7.2.min.js"></script>
<script src="js/jquery-ui-1.8.20.custom.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
	<style type="text/css">
		body{ font: 62.5% "Trebuchet MS", sans-serif; margin: 50px;}
        div.graphstuff{width: 600px;}        
	</style>
</head>
<body>
<h1>Beaglebone + BeBoPr cape</h1>

<div id="radio">
    <input type="radio" id="ioenabled" name="radio" /><label for="ioenabled">Enabled</label>
	<input type="radio" id="iodisabled" name="radio" checked="checked" /><label for="iodisabled">Disabled</label>
</div><br/><br/>

<div class="graphstuff">
    <canvas id="ainCanvas">2</canvas>
    <center><div id="graphenable">
        <input type="checkbox" id="AIN2" checked="true"/><label for="AIN2">AIN2</label>
    	<input type="checkbox" id="AIN4" /><label for="AIN4">AIN4</label>
    	<input type="checkbox" id="AIN6" /><label for="AIN6">AIN6</label>
    </div></center>
    <div>
        PWM0 duty cycle %
        <div id="pwm0Slider"></div>
    </div><br>
    <div>
        PWM1 duty cycle %
        <div id="pwm1Slider"></div>
    </div><br>
    <div>
        PWM2 duty cycle %
        <div id="pwm2Slider"></div>
    </div><br>
</div>

<h2>Status:</h2>
<p><span id="status">Not yet connected</span></p>


<script src="/socket.io/socket.io.js"></script>
<script src="js/processing-1.3.6.min.js"></script>
<script type="text/javascript">
var socket = new io.connect();
socket.on('connect', function() {
    document.getElementById("status").innerHTML="Connected";
});

var graphDataSize = 300;
graphData = new Array(3);
graphData[0] = new Array(graphDataSize);
graphData[1] = new Array(graphDataSize);
graphData[2] = new Array(graphDataSize);

graphEnabled = [1,0,0];

var sketchProc = function(p) {
		p.size(600, 250);
        
		// variables referenced elsewhere
		window.height = p.height;

		// variables that might get updated
		window.rangeLow = 0;
		window.rangeHigh = 250;
		window.scaleY = window.height / (window.rangeHigh - window.rangeLow);

		// local variables
		var stepX = p.width / (graphDataSize - 1);
		var bottomY = window.height - 1;
		p.draw = function() {
            p.fill(255);
			// erase background
			p.background(224);

			// draw axis
			p.stroke(25);
			p.strokeWeight(1);
			p.line(0, bottomY, p.width, bottomY);

            p.fill(0);
            p.stroke(150);
            for (lineY = 0 ; lineY < window.rangeHigh + 1 ; lineY = lineY + 5) {
            	for (dashValue = 0; dashValue < p.width ; dashValue = dashValue + 5) {
    				dashPoint = 1;
	    			p.line(dashValue * dashPoint, lineY, (dashValue * dashPoint) , lineY);
		    	}
            }
            p.stroke(25);

            for (lineY = 0 ; lineY < window.rangeHigh + 1 ; lineY = lineY + 50) {
                p.text(250 - lineY , 0, lineY - 2);
    			for (dashValue = 0; dashValue < p.width/10 ; dashValue = dashValue + 1) {
    				dashPoint = 10;
	    			p.line(dashValue * dashPoint, lineY, (dashValue * dashPoint) + 5, lineY);
		    	}
            }
            
			// draw graph
            for (i = 0; i < 3; i = i + 1) {
                if (graphEnabled[i] == 1) {
                	p.stroke((i % 3) * 255, (i % 2) * 255, 255);
                	p.strokeWeight(1);
                	p.fill((i % 3) * 255, (i % 2) * 255, 255);
                	var lastX = 0,
                		nextX = 0,
                		lastY, nextY;
                	for (var point in graphData[i]) {
                		nextY = ((window.rangeHigh - graphData[i][point]) * scaleY);
                		if (point != 0) {
                			p.line(lastX, lastY, nextX, nextY);
                			lastX += stepX;
                		}
                		nextX += stepX;
                		lastY = nextY;
                	}
                	p.text(Math.round(graphData[i][point]), p.width - 20, lastY - 2);
                	p.text("AIN" + (i + 1) * 2 + ": " + Math.round(graphData[i][point] * 10) / 10, p.width - 64, 16 * (i + 1));
                }
            }
		};

		p.noLoop();
	}

var aincanvas = document.getElementById("ainCanvas");
var processing = new Processing(aincanvas, sketchProc);

socket.on('ain', function(data) {
    if(!data[2])
        data[2] = 0;

    if(!data[4])
        data[4] = 0;

    if(!data[6])
        data[6] = 0;

    //document.getElementById("ain2temp").innerHTML="AIN2: " + data[2] + "&#8451";
    //document.getElementById("ain4temp").innerHTML="AIN4: " + data[4] + "&#8451";
    //document.getElementById("ain6temp").innerHTML="AIN6: " +data[6] + "&#8451";
    
     for (j = 0; j < 3 ; j = j +1) {
         var myData = parseFloat(data[(j+1)*2]);
         for (var i = 0; i < graphDataSize - 1; i++) {
         	window.graphData[j][i] = window.graphData[j][i + 1];
         }
         window.graphData[j][i] = myData;
     }
     processing.redraw();
    
    setTimeout(function() {socket.emit('getTemp', 1);}, 1000);
});

socket.on('PWM', function(data) {
    pwm0dutypercent = data[0];
    pwm1dutypercent = data[1];
    pwm2dutypercent  = data[2];
    
    $('#pwm0Slider').slider( "option", "value", pwm0dutypercent );
    $('#pwm1Slider').slider( "option", "value", pwm1dutypercent );
    $('#pwm2Slider').slider( "option", "value", pwm2dutypercent );
    setTimeout(function() {socket.emit('getPWM', 1);}, 1000);
});

socket.on('ioenableState', function(data) {
    if(data > 0)
        //$( "#radio" ).button( "option", "enabled", true ).button("refresh");
        $('#ioenabled').attr('checked','checked').button("refresh");
});

socket.emit('getTemp', 1);
socket.emit('getPWM', 1);

$(function() {
    $("#radio").buttonset();
    socket.emit('ioenable', "read");
    $("#radio :radio").click(function(){
        //alert($(this).attr("id"));
        if($(this).attr("id") == "ioenabled")
            socket.emit('ioenable',"enable");
        else
            socket.emit('ioenable',"disable");
    });          

    $("#graphenable").buttonset();
    $("#graphenable :checkbox").click(function(){
        //alert($(this).attr("id") + " " + $(this).is(":checked"));
        if($(this).attr("id") == "AIN2") {
            if ($(this).is(":checked"))
                graphEnabled[0] = 1;
            else
                graphEnabled[0] = 0;
        }
        if($(this).attr("id") == "AIN4") {
            if ($(this).is(":checked"))
                graphEnabled[1] = 1;
            else
                graphEnabled[1] = 0;
        }
        if($(this).attr("id") == "AIN6") {
            if ($(this).is(":checked"))
                graphEnabled[2] = 1;
            else
                graphEnabled[2] = 0;
        }
        processing.redraw();
    });

    // only report changes if they weren't done programatically via getPWM
    $('#pwm0Slider').slider({ min: 0, max: 100, step: 1, animate: true,
        change: function(event, ui) {  
            if(event.originalEvent!=undefined) 
                socket.emit('pwmdutypercent', [ 0, ui.value ]); 
        }
    });
    $('#pwm1Slider').slider({ min: 0, max: 100, step: 1, animate: true,
        change: function(event, ui) {
            if(event.originalEvent!=undefined) 
                socket.emit('pwmdutypercent', [ 1, ui.value ]); 
        }
    });
    $('#pwm2Slider').slider({ min: 0, max: 100, step: 1, animate: true,
        change: function(event, ui) { 
            if(event.originalEvent!=undefined) 
                socket.emit('pwmdutypercent', [ 2, ui.value ]); 
            }
    });
});

</script>

</body>
</html>
